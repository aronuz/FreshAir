<template>
  <ClientOnly>
    <FormModal v-model="isOpenUser" :selected-user="selectedUser" @saved="updateSelectedUser"/>
    <EventsModal v-if="selectedUser && isOpenEvents" v-model="isOpenEvents" :groupped-events="appointments" :user="selectedUser.title"/>
      
    <UCard>
      <template #header class="text-xl font-semibold">Admin Panel</template>

      <UTabs :unmount-on-hide="false" :items="tabItems" class="w-full">
        <template #content="{ item }">
          <UCard>
            <template #header class="text-xl font-semibold">{{ item.label }}</template>
            <template v-if="item.label === 'User Management'">
              <div v-if="!users.length && !pending">No Users</div>
              <template v-else-if="!users.length && pending">
                <USkeleton v-for="i in 3" class="mx-auto mt-1 h-2 w-full bg-gray-600" as="div"/>
              </template>
              <div v-else>
                <UTable v-if="isMD" ref="userTable" :data="users" :columns="columns" :ui="{
                  wrapper: 'overflow-x-auto',
                  thead: 'hidden md:table-header-group',
                  tbody: 'block md:table-row-group'
                }">
                  <template #appointments-cell="{ row }">
                    <UButton @click="loadUserEvents(row.original as userType)" label="See Appointments" />
                  </template>
                  <template v-if="selectedUsers.length" #actions-cell="{ row }">
                    <UButton class="bg-blue-500 text-white px-2 py-1 rounded" @click="handleUpdateUser(row.original as userType)" label="Edit" />
                    <UButton class="bg-red-500 text-white px-2 py-1 rounded" @click="handleDeleteUsers((row.original as userType).user_id)" label="Remove" />
                  </template>
                </UTable>
                <template v-else>
                  <div v-for="user in users" :key="user.user_id" class="flex justify-between p-3 bg-gray-100 rounded">
                    <div class="grid grid-cols-5 grid-rows-1 gap-4">
                      <UCheckbox @changed="updateSelectedUsers($event, user.user_id)" />
                      <div >{{ user.title }} - {{ user.phone }}<span v-if="user.email">/{{ user.email }}</span></div>
                      <div >Profile created on: {{ user.created_at }}</div>
                      <UButton @click="loadUserEvents(user)" label="See Appointments" />
                      <div v-if="selectedUsers.length" class="space-x-2">
                        <UButton class="bg-blue-500 text-white px-2 py-1 rounded" @click="handleUpdateUser(user)" label="Edit" />
                        <UButton class="bg-red-500 text-white px-2 py-1 rounded" @click="handleDeleteUsers(user.user_id)" label="Remove" />
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </template>
            <template v-else>
              <div class="grid grid-cols-2 md:grid-cols-4 font-semibold bg-gray-100 p-2 rounded">
                <div>Page</div>
                <div class="hidden md:block">Show/Hide</div>
                <div class="hidden md:block">Path</div>
              </div>
              <div v-for="page in pages" :key="page.to" class="grid grid-cols-2 md:grid-cols-4 grid-rows-3 border-b p-3 bg-gray-100 hover:bg-gray-50 transition rounded">
                <template v-if="isMD">
                  <div class="col-span-2 md:col-span-1">{{ page.name }}</div>
                  <UCheckbox class="flex-none my-auto" :class="{'col-span-2': !page.allowed}" v-model="page.allowed" :label="page.allowed ? 'Shown' : 'Hidden'"/>
                  <UFormField v-if="page.allowed" class="flex-auto">
                    <USelect v-model="pathPicked[page.name]" :items="[page.to, getOldPath(page)]" value-key="id" class="w-full" label="Path" arrow />
                  </UFormField>
                </template>
                <div v-else class="flex justify-start align-bottom">
                  <UCheckbox class="flex-none my-auto" v-model="page.allowed"/>
                  <UFormField v-if="page.allowed" class="flex-auto">
                    <USelect v-model="pathPicked[page.name]" :items="[page.to, getOldPath(page)]" value-key="id" class="w-full" label="Path" arrow />
                  </UFormField> 
                </div>
                <UButton class="col-span-2 md:col-span-1 justify-self-end flex items-center justify-center w-1/4 md:w-1/2 bg-blue-500 text-white rounded" @click="savePageInfo({pageName: page.name, path: pathPicked[page.name], allowed: page.allowed, oldPath: page.to})" label="Save" />
              </div> 
            </template>
            
            <template #footer v-if="item.label === 'User Management'">
              <UButton icon="i-heroicons-plus-circle" color="primary" variant="solid" label="Add" @click="isOpenUser = true"/>
              <UButton icon="i-heroicons-x-circle" color="error" variant="solid" label="Remove" @click="handleDeleteUsers(selectedUsers)"/>
            </template>
          </UCard>
        </template>
      </UTabs>

    </UCard>
  </ClientOnly>
</template>

<script lang="ts" setup>
import { h, ref, resolveComponent } from 'vue'
import type { TableColumn, TabsItem } from '@nuxt/ui'
import { breakpointsTailwind, useBreakpoints } from '@vueuse/core'

const UCheckbox = resolveComponent('UCheckbox')
const { toastBar } = useToastBar()
const breakpoints = useBreakpoints(breakpointsTailwind)
const isMD = breakpoints?.greaterOrEqual('md')

interface userType {
  title: string,
  phone: string,
  email: string | undefined,
  role: string | undefined,
  user_id: string,
  created_at: string,
}

interface stateType {
  address?: string | undefined,
  start_date?: Date | string | undefined,
  start_time?: string | undefined,
  end_date?: Date | string | undefined,
  end_time?: string | undefined,
  service?: number | undefined,
  notes?: string | undefined,
  zip?: string | undefined,
}

interface pages {
  name: string,
  to: string,
  allowed: boolean,
  oldPath?: string | null
}

interface pageItem {
    name: string,
    to: string,
    allowed: boolean,
    oldPath?: string | null
}

interface pathType {
  [key: string]: string
}

const tabItems = ref<TabsItem[]>([
  {
    label: 'User Management',
    icon: 'i-lucide-user',
  },
  {
    label: 'Page Access',
    icon: 'i-lucide-library',
  }
])

const onError = useNuxtApp().$onError
const users = ref<userType[]>([])
const selectedUser = ref<userType | null | undefined>(null)
const selectedUsers = ref<string[]>([])
const appointments = ref<stateType[]>([])

const isOpenUser = ref(false)
const isOpenEvents = ref(false)

const columns = ref<TableColumn<userType>[]>([
  {
    id: 'select',
    header: ({ table }) =>
      h(UCheckbox, {
        modelValue: table.getIsSomePageRowsSelected()
          ? 'indeterminate'
          : table.getIsAllPageRowsSelected(),
        'onUpdate:modelValue': (value: boolean | 'indeterminate') =>
          table.toggleAllPageRowsSelected(!!value),
        'aria-label': 'Select all'
      }),
    cell: ({ row }) =>
      h(UCheckbox, {
        modelValue: row.getIsSelected(),
        'onUpdate:modelValue': (value: boolean | 'indeterminate') => {
          row.toggleSelected(!!value)
          const isSelected = typeof value === 'boolean' ? value : false
          updateSelectedUsers(isSelected, row.getValue('user_id'))
        },
        'aria-label': 'Select user'
      }),
  },
  {
    accessorKey: 'title',
    header: 'Name',
    cell: ({ row }) => row.getValue('title')
  },
  {
    accessorKey: 'phone',
    header: 'Phone',
    cell: ({ row }) => row.getValue('phone')
  }, 
  {
    accessorKey: 'email',
    header: 'Email',
    cell: ({ row }) => {
      const email = row.getValue('email')??'No Email'
      return email
    }
  },
  {
    accessorKey: 'created_at',
    header: 'Joined On',
    cell: ({ row }) => {
      return new Date(row.getValue('created_at')).toLocaleString('en-US', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        // hour: '2-digit',
        // minute: '2-digit',
        // hour12: true
      })
    }
  },
  {
    accessorKey: 'role',
    header: 'Role',
    cell: ({ row }) => row.getValue('role')
  },
  {
    id: 'appointments'
  },
  {
    id: 'actions'
  }
])

const pages = reactive<pages[]>([{ name: 'Home', to: '/index', allowed: true, oldPath: null }, 
{ name: 'Services', to: '/services', allowed: true, oldPath: null }, 
{ name: 'Schedule Service', to: '/booking', allowed: true, oldPath: null }, 
{ name: 'Contact Us', to: '/contact', allowed: true, oldPath: null }, 
{ name: 'About Us', to: '/about', allowed: true, oldPath: null }])

const pathPicked: pathType = reactive({
  'Home': '/index',
  'Services': '/services', 
  'Schedule Service': '/booking',
  'Contact Us': '/contact',
  'About Us': '/about'
})

const { getPageAccess,
        updatePageAccess,
        fetchUsers,
        deleteUsers,
        fetchAppointments,
        pending } = useFetchQueries()

const updateSelectedUser = (event: userType | null) => {
  selectedUser.value = null
  if (event) {
    users.value = users.value.map(user => {
      if (user.user_id === event.user_id) {
        return {...user, ...event}
      }
      return user
    })
  }
} 

const updateSelectedUsers = async (event: boolean, id: string) => {
  if (event) selectedUsers.value.push(id)
  else selectedUsers.value = selectedUsers.value.filter(item => item !== id)
}

const handleLoadUsers = async () => {
  try {
    const { data, error, isPending } = await fetchUsers(pending)
    pending.value = isPending.value
    if (error) {
      onError(500, error)
      return
    }
    users.value = data || []
  } catch (error) {
    onError(500, error)
  }
}

const handleDeleteUsers = async (ids: string | string[]) => {
  try {
    const user_ids = !Array.isArray(ids) ? [ids] : ids
    const { error, isPending } = await deleteUsers(pending, user_ids)
    pending.value = isPending.value
    if (error) {
      onError(500, error)
      return
    } else {
      users.value = users.value.filter(user => !(user.user_id in user_ids))
    }
  } catch (error) {
    onError(500, error)
  } 
}

onMounted(async () => {
  await handleLoadUsers()
  
  getPageAccess().then(({data, error}) => {
    if(error) {
      onError(500, error)
      return
    }
    if(data) {
      data.forEach((pageItem: pageItem) => {
        const item = pages.find((page) => page.name === pageItem.name)
        item!.to = pageItem.to
        item!.allowed = pageItem.allowed
        item!.oldPath = pageItem.oldPath ?? null
        pathPicked[item!.name] = item!.to
      })
      console.log('Page access loaded:', pages)
    }
  }).catch(error => { 
    onError(500, error)
  })
})  

const handleUpdateUser = async (user: userType) => {
  selectedUser.value = user
  isOpenUser.value = true
}

const loadUserEvents = async (user: userType) => {
  const {data, isPending, error, status} = await fetchAppointments(pending, 0, user.user_id, true)
  pending.value = isPending.value
  if(error){
    onError(status, error)
    return
  }
  selectedUser.value = user
  appointments.value = data ?? []
  isOpenEvents.value = true
}

watch(isOpenUser, (val) => {
  if (!val) selectedUser.value = null
})

const getOldPath = (page: pageItem) => {
  return page.oldPath ?? '/construction'
}

const savePageInfo = async ({ pageName: name, path: to, allowed, oldPath }: { pageName: string, path: string, allowed: boolean, oldPath: string }) => {
  try {
    const {error} = await updatePageAccess({ name, to, allowed, oldPath })
    if (error) {
      onError(500, error.message)
      return
    }
    toastBar('success', 'Page access updated successfully')
  } catch (error) {
    onError(500, error)
  }
}
// const sendEmail = async () => {
//   try {
//     await $fetch('/api/send-email', {
//       method: 'POST',
//       body: emailData.value,
//     });
//   } catch (e) {
//     error.value = e;
//     onError( 500, error.value)
//   }
//   emailData.value = { to: '', subject: '', body: '' };
// };

definePageMeta({
  layout: "default"
})
</script>

<style scoped>
#calendar {
  width: 80%;
  margin: 20px auto;
}
</style>